<!DOCTYPE html><html>
<head>
  <meta charset="UTF-8" />
  <title>Chat with File Send</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
  <style>
    body { font-family: sans-serif; background: #ece5dd; margin: 0; }
    #login, #chat-section, #contacts-screen { display: none; padding: 20px; }
    #chat-box { height: 70vh; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; }
    .msg { max-width: 70%; margin: 5px; padding: 10px; border-radius: 10px; position: relative; word-break: break-word; }
    .me { align-self: flex-end; background: #dcf8c6; }
    .other { align-self: flex-start; background: #fff; }
    #input-area { display: flex; padding: 10px; background: #fff; position: fixed; bottom: 0; width: 100%; box-sizing: border-box; gap: 5px; }
    #msg { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 20px; }
    button { padding: 6px 12px; border: none; background: #128c7e; color: #fff; border-radius: 20px; }
    #header { display: flex; align-items: center; padding: 10px; background: #075E54; color: #fff; position: relative; }
    #header .name { flex: 1; font-weight: bold; }
    #backBtn { background: none; color: white; font-size: 18px; border: none; margin-right: 10px; cursor: pointer; }
  </style>
</head>
<body>
  <div id="login">
    <h2>Enter Your Code</h2>
    <input id="myCode" placeholder="Your ID e.g. SHOAIB" />
    <button onclick="login()">Login</button>
  </div>  <div id="contacts-screen">
    <h3>Welcome: <span id="myCodeDisplay"></span></h3>
    <input id="friendCode" placeholder="Add friend's code" />
    <button onclick="addContact()">Add</button>
    <h4>Contacts:</h4>
    <div id="contacts"></div>
  </div>  <div id="chat-section">
    <div id="header">
      <button id="backBtn" onclick="backToContacts()">‚Üê</button>
      <div class="name" id="chat-name"></div>
    </div>
    <div id="chat-box"></div>
    <div id="input-area">
      <input type="text" id="msg" placeholder="Type a message" />
      <input type="file" id="fileInput" style="display:none" />
      <button onclick="document.getElementById('fileInput').click()">üìé</button>
      <button onclick="send()">Send</button>
    </div>
  </div><script>
const firebaseConfig = {
  apiKey: "AIzaSyClb5C0c2JL-D4555yST-mwHBeUE4H2nhY",
  authDomain: "malik-6f6b3.firebaseapp.com",
  databaseURL: "https://malik-6f6b3-default-rtdb.firebaseio.com",
  projectId: "malik-6f6b3",
  storageBucket: "malik-6f6b3.appspot.com",
  messagingSenderId: "784331899173",
  appId: "1:784331899173:web:4cf46dcf1621f40a6f9acc"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const storage = firebase.storage();

let me = '', other = '', contacts = [];

function login() {
  const code = document.getElementById('myCode').value.trim();
  if (!code) return alert("Enter your code");
  me = code;
  document.getElementById('login').style.display = 'none';
  document.getElementById('contacts-screen').style.display = 'block';
  document.getElementById('myCodeDisplay').innerText = me;
  contacts = JSON.parse(localStorage.getItem('contacts') || '[]');
  db.ref('status/' + me).set("online");
  db.ref('status/' + me).onDisconnect().set("last seen: " + new Date().toLocaleString());
  renderContacts();
}

function addContact() {
  const code = document.getElementById('friendCode').value.trim();
  if (!code || code === me || contacts.includes(code)) return;
  contacts.push(code);
  localStorage.setItem('contacts', JSON.stringify(contacts));
  renderContacts();
  document.getElementById('friendCode').value = '';
}

function renderContacts() {
  const container = document.getElementById('contacts');
  container.innerHTML = '';
  contacts.forEach(code => {
    const btn = document.createElement('button');
    btn.innerText = code;
    btn.style.display = 'block';
    btn.style.margin = '5px';
    btn.onclick = () => openChat(code);
    container.appendChild(btn);
  });
}

function backToContacts() {
  document.getElementById('chat-section').style.display = 'none';
  document.getElementById('contacts-screen').style.display = 'block';
  document.getElementById('chat-box').innerHTML = '';
}

function openChat(friendCode) {
  other = friendCode;
  document.getElementById('contacts-screen').style.display = 'none';
  document.getElementById('chat-section').style.display = 'block';
  document.getElementById('chat-name').innerText = other;
  const chatId = [me, other].sort().join('_');
  const ref = db.ref('chats/' + chatId);
  document.getElementById('chat-box').innerHTML = '';
  ref.off();
  ref.on('child_added', snap => {
    const m = snap.val();
    const div = document.createElement('div');
    div.className = 'msg ' + (m.from === me ? 'me' : 'other');
    if (m.file && m.url) {
      if (m.file.startsWith('image/')) {
        div.innerHTML = `<img src="${m.url}" style="max-width:200px; border-radius:10px;"><div style="font-size:12px; text-align:right;">${formatTime(m.time)}</div>`;
      } else {
        const fname = m.text || "Download file";
        div.innerHTML = `<a href="${m.url}" download style="color:blue">üìÑ ${fname}</a><div style="font-size:12px; text-align:right;">${formatTime(m.time)}</div>`;
      }
    } else {
      div.innerHTML = `${m.text}<div style="font-size:12px; text-align:right;">${formatTime(m.time)}</div>`;
    }
    document.getElementById('chat-box').appendChild(div);
    document.getElementById('chat-box').scrollTop = document.getElementById('chat-box').scrollHeight;
  });
}

function formatTime(t) {
  return new Date(t).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

function send() {
  const input = document.getElementById('msg');
  const fileInput = document.getElementById('fileInput');
  const chatId = [me, other].sort().join('_');

  if (fileInput.files.length > 0) {
    const file = fileInput.files[0];
    const ref = storage.ref('files/' + chatId + '/' + Date.now() + '_' + file.name);
    ref.put(file).then(snapshot => {
      snapshot.ref.getDownloadURL().then(url => {
        db.ref('chats/' + chatId).push({
          from: me,
          url: url,
          file: file.type,
          text: file.name,
          time: Date.now(),
          status: 'sent'
        });
      });
    });
    fileInput.value = '';
    return;
  }

  const msg = input.value.trim();
  if (!msg) return;
  db.ref('chats/' + chatId).push({
    from: me,
    text: msg,
    time: Date.now(),
    status: 'sent'
  });
  input.value = '';
}
</script></body>
</html>
